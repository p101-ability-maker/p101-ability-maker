<!DOCTYPE html>
<html>
  <head>
    <title>P101 Ability Maker</title>

    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="description" content="Custom P101 Power + Talent maker. Create your own P101 abilities without having to do the hard work. Works best on computers." />
    <meta name="keywords" content="pirate101, p101, pirate, power, talent, ability, creator, maker" />

    <meta name="og:title" content="P101 Ability Maker" />
    <meta name="og:url" content="https://p101-ability-maker.github.io" />
    <meta name="og:description" content="Custom P101 Power + Talent maker. Create your own P101 abilities without having to do the hard work. Works best on computers." />
<!-- need to get an icon
    <meta name="og:image" content="https://github.com/cody-nightblade/cody-nightblade.github.io/blob/gh-pages/other-images/Scorp%20Corp.png?raw=true" />
    <meta name="og:image:width" content="100" />
    <meta name="og:image:height" content="100" />
-->

    <link rel="stylesheet" href="styles.css"/>

    <style>
      .creator input { width: auto; box-shadow: none; color: black; }
      .creator textarea {
        width: 180px;
        resize: none;
      }
      .icon {
        vertical-align: middle;

        padding-bottom: 4px; padding-left: 1px;

        max-width: 16px;
      }
      .iconL {
        vertical-align: middle; padding-bottom: 4px; padding-left: 2px;
        max-width: 20px;
      }
      #inf {
        position: absolute;
        top: 48px;
        left: 97px;
      }
      .creator select { width: 175px; }

      #img-src { width: 180px; border: 0px solid transparent;
        border-radius: 0px; background-color: transparent;}

      #title,#desc { font-family: Arial; }
      #title { height: 20px; }
      #desc { height: 60px; }
      #top-left-icon { position: absolute; top: 47px; left: 10px; max-width: 32px; }
      #top-right-icon { position: absolute; top: 43px; left: 109px; max-width: 32px; }
      #bottom-left-icon { position: absolute; top: 137px; left: 10px; max-width: 32px; }
      #bottom-right-icon { position: absolute; top: 137px; left: 110px; max-width: 32px; }

      #fc,#tr,#bl,#br { width: 30px; }
      #tl-text,#tr-text,#bl-text,#br-text{
        position: absolute;
        width: 54px;
        resize: none;
        padding: 0px;
        font-family: shermlock;
        font-size: 15px;
        color: white;

        transform: scale(1, 0.8);

        text-shadow: 0 0 5px black, 0 0 5px black, 0 0 5px black, 0 0 5px black, 0 0 5px black,
          0 0 5px black, 0 0 5px black, 0 0 5px black, 0 0 5px black;
      }
      #tl-text { top: 57px; left: 11px; }
      #tr-text { top: 57px; left: 87px; }
      #bl-text { top: 150px; left: 11px; }
      #br-text { top: 150px; left: 87px; }

      #zoom-input { width: 40px; }

      #rnk { width: 100px; }
      #rnk-text {
        position: absolute;
        top: 233px;
        left: 11px;
        width: 132px;
        height: 20px;
        padding: 0px;
        font-family: "Comic Sans MS";
        font-size: 12px;
        font-weight: 600;
        overflow: hidden;
        text-shadow: none;
        cursor: context-menu;
      }

      #resultTitle {
        position: absolute;
        top: 12px;
        left: 10px; /* ttl width: 152px, left = 10 at max width */
        max-width: 132px;

        resize: none;
        padding: 0px;

        font-family: shermlock, Arial;
        font-size: 15px; /* 15px = 1.5em */
        color: #FCEF01;
        text-align: center;
        letter-spacing: 0.5px;
        line-height: 15px;

        -ms-transform: scale(1, 0.8);
        transform: scale(1, 0.8);

        background-color: transparent;
        border: 0px solid transparent;
        readonly: true;
        resize: none;
        outline: none;
        overflow: hidden;

        cursor: context-menu;
      }

      #resultDescCont {
        /* positioning */
        position: absolute;
        top: 170px;
        left: 10px;
        width: 132px;
          /* height is excluded because of updateBG() */

        padding: 0px;
        border: none;
        overflow: hidden;
      }

      #resultDesc {
        /* center horizontal + vertical */
        margin: 0;
        position: absolute;
        top: 50%;
        left: 50%;
        -ms-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
        width: 132px;

        /* font settings */
        font-family: "Comic Sans MS", Arial;
        font-size: 12px; /* 12px = 1.2em */
        line-height: 15px;
        font-weight: 600;
        color: black;
        text-align: center;

        cursor: context-menu;
      }

      #main-image-wrapper {
        position: absolute;
        top: 45px;
        left: 17px;
        width: 119px;
        height: 119px;
        cursor: grab;
        overflow: auto;

        -ms-overflow-style: none; /* for Internet Explorer, Edge */
        scrollbar-width: none; /* for Firefox */
      }
      #main-image-wrapper::-webkit-scrollbar { display: none; }

      #main-image-frame {
        position: absolute;
        top: 44px;
        left: 16px;
        width: 121px;
        height: 121px;
      }

      #hovertext {
        position: absolute;

        font-family: 'Comic Sans MS';
        font-size: 14px;
        color: white;
        text-align: right;
        white-space: nowrap;

        text-shadow: 0 0 5px black, 0 0 5px black, 0 0 5px black, 0 0 5px black,
            0 0 5px black, 0 0 5px black, 0 0 5px black, 0 0 5px black;
      }

      #bg-download { color: blue; }

      .size150 {
        font-size: 18px; /* 18px = 1.8em */
      }
      .size150 .icon {
        width: 32px;
        max-width: 32px;
      }

      .size125 {
        font-size: 17px; /* 17px = 1.7em */
      }
      .size125 .icon {
        width: 24px;
        max-width: 24px;
      }

/*
      #resultimagecont {
        position: relative;
        width: 152px;
        height: 256px;

        -ms-transform: scale(0.8, 0.8);
        transform: scale(0.8, 0.8);

      }
*/

    </style>

  </head>

  <body class="creator" onload="initialize()">
    <script>
//      const title_space = " "; // actual space: 1/6 em
//      const title_space = " "; // actual space: 1/4 em
      const title_space = " "; // normal space
      function isUpperCase(c) { return c == c.toUpperCase(); }

      const key_icon = [
        // Stats ----------------------------------
        ["[health]", "Health_L.png"],
        ["[weapon-power]", "Weapon Power_L.png"],
        ["[spell-power]", "Spell Power_L.png"],
        ["[strength]", "Strength_L.png"],
        ["[agility]", "Agility_L.png"],
        ["[will]", "Will_L.png"],
        ["[accuracy]", "Accuracy_L.png"],
        ["[dodge]", "Dodge_L.png"],
        ["[haste]", "Movement_L.png"],
        ["[range]", "Range_L.png"],
        ["[critical]", "Critical_L.png"],

        // Damage ---------------------------------
        ["[phys-dmg]", "Physical Damage_L.png"],
        ["[magic-dmg]", "Magical Damage_L.png"],
        ["[armor]", "Armor_L.png"],
        ["[resist]", "Resist_L.png"],
        ["[pierce]", "Armor Piercing_L.png"],
        ["[poison]", "Poison.png"],
        ["[bleeding]", "Bleeding.png"],

        // Effects ---------------------------------
        ["[buff]", "Buff_L.png"],
        ["[debuff]", "Debuff_L.png"],
        ["[rounds]", "Duration_L.png"],
        ["[dice]", "Dice_L.png"],
        ["[talent]", "Talent Rank.png"],
        ["[threat]", "Threat Generation_L.png"],

        // Weapon Types ---------------------------------
        ["[slashy]", "Melee_L.png"],
        ["[smashy]", "Smashy Weapon.png"],
        ["[stabby]", "Stabby Weapon.png"],
        ["[shooty]", "Shooty Weapon.png"],
        ["[staffy]", "Staffy Weapon.png"],

        // Class Traps ---------------------------------
        ["[claw-trap]", "Claw Trap.png"],
        ["[bear-trap]", "Bear Trap.png"],
        ["[scatter-spike]", "Scatter Spike Trap.png"],
        ["[musket-trap]", "Musketeers Trap.png"],
        ["[bonfire]", "Bonfire Trap.png"],

        // Other Traps ---------------------------------
        ["[blood-flames]", "Blood Flames.png"],
        ["[spike-trap]", "Singular Spike Trap.png"],
        ["[starfish]", "Starfish.png"],
        ["[storm-cloud]", "Storm Cloud.png"],

        // Obstacles   ---------------------------------
        ["[barricade]", "Barricade.png"],
        ["[powder-keg]", "Powder Keg.png"],
        ["[ice-wall]", "Ice Obstacle.png"],
        ["[stone-wall]", "Stone Obstacle_L.png"],

        // Summons -------------------------------------
        ["[skeletal-pirate]", "Skeletal Pirate.png"],
        ["[skeletal-corsair]", "Skeletal Corsair.png"],
        ["[bone-drake]", "Bone Drake.png"],
        ["[skeleton-hoplite]", "Skeleton Hoplite.png"],
        ["[skeletal-warrior]", "Skeletal Warrior.png"],
        ["[golem]", "Golem.png"],
        ["[crab-crawlie]", "Crab Crawlie.png"],
        ["[scorpion]", "Scorpion.png"],
        ["[lagooney]", "Lagooney.png"],
        ["[cherry-treant]", "Cherry Blossom Treant.png"],
        ["[blue-oni]", "Blue Oni.png"],
        ["[terracotta]", "Terracotta Warrior.png"],
        ["[terror-cotta]", "Terror-cotta Warrior.png"],

        // Other ---------------------------------------
        ["[aoe]", "AoE.png"],
        ["[haste2]", "Movement specify.png"],
        ["[range2]", "Range specify.png"],
        ["[bonus-on-enemy]", "Bonus Effects on Enemy Territory.png"],
        ["[flank]", "must flank the enemy.png"],

        // W101 Icons ----------------------------------
        ["[drain]", "W101 Drain_L.png"],
        ["[stun]", "W101 Stun_L.png"],
        ["[incoming]", "W101 Incoming_L.png"],
        ["[outgoing]", "W101 Outgoing_L.png"],
        ["[afterlife]", "W101 Afterlife_L.png"]
      ];
      const key_tag = [
        // Custom Tags ---------------------------------
        ["[medium]", "<span class='size125'>"],
        ["[/medium]", "</span>"],
        ["[large]", "<span class='size150'>"],
        ["[/large]", "</span>"]
      ];

      let title = "";
      let desc = "";

      function initialize() {
        updateBG();
      }

      function updateBG() {
        let nextAbility = document.getElementById("ability-type").value;
        if (nextAbility == "power") {
          document.getElementById("bg").src = "ability-creator-images/power-template.png";
          document.getElementById("resultDescCont").style.height = "75px";
          document.getElementById("resultDesc").style.maxHeight = "75px";
          document.getElementById("rnk-wrapper").hidden = true;
          document.getElementById("rnk-text").hidden = true;
        } else {
          document.getElementById("bg").src = "ability-creator-images/talent-template.png";
          document.getElementById("resultDescCont").style.height = "62px";
          document.getElementById("resultDesc").style.maxHeight = "62px";
          document.getElementById("rnk-wrapper").hidden = false;
          document.getElementById("rnk-text").hidden = false;
        }
        updateRank();
      }

      function changeTitleFontSize() {
        let newsz = "15px";
        if (document.getElementById("fonttoggle").checked) { newsz = "10px"; }
        document.getElementById("resultTitle").style.fontSize = newsz;
      }

      function updateRank() {
        let tx = document.getElementById("rnk").value;
        document.getElementById("rnk-text").innerHTML = "Rank " + tx;
      }

      function updateTitle() {
        title = document.getElementById("title").value;
        title = title.replaceAll(" ", title_space);
        document.getElementById("resultTitle").value = title;
      }

      function updateTextBL() {
        let tx = document.getElementById("bl").value;
        document.getElementById("bl-text").innerHTML = tx;
      }

      function updateTextBR() {
        let tx = document.getElementById("br").value;
        document.getElementById("br-text").innerHTML = tx;
      }

      function updateTextTL() {
        let tx = document.getElementById("fc").value;
        document.getElementById("tl-text").innerHTML = tx;
      }

      function updateTopLeftIcon() {
        let newic = "";
        let vis = false;
        let ic = document.getElementById("top-left").value;
        if (ic !== "none") { vis = true; }
        if (ic == "fc") {
          newic = "ability-creator-images/icons/Fire Count X_L.png";
        }
        if (ic == "duration") {
          newic = "ability-creator-images/icons/Duration_L.png";
        }

        document.getElementById("fc-wrapper").hidden = !vis;
        document.getElementById("tl-text").hidden = !vis;
        document.getElementById("top-left-icon").src = newic;

        updateTextTL();
      }

      function updateTextTR() {
        let tx = document.getElementById("tr").value;
        let tp = document.getElementById("top-right").value;
        if (tp == "range" || tp == "haste") {
          if (tx == "inf") {
            document.getElementById("tr-text").hidden = true;
            document.getElementById("inf").hidden = false;
          } else {
            document.getElementById("tr-text").innerHTML = tx;
            document.getElementById("tr-text").hidden = false;
            document.getElementById("inf").hidden = true;
          }
        } else {
          document.getElementById("tr-text").hidden = true;
          document.getElementById("inf").hidden = true;
        }
      }

      function updateTopRightIcon() {
        let newic = "";
        let ic = document.getElementById("top-right").value;

        if (ic == "haste") { newic = "ability-creator-images/icons/Movement specify.png"; }
        if (ic == "range" || ic == "ranged") { newic = "ability-creator-images/icons/Range specify.png"; }
        if (ic == "melee") { newic = "ability-creator-images/icons/Melee_L.png"; }
        if (ic == "magic") { newic = "ability-creator-images/icons/Spell Power_L.png"; }

        if (ic == "range" || ic == "haste") {
          document.getElementById("tr-wrapper").hidden = false;
          document.getElementById("tr-text").hidden = false;
        } else {
          document.getElementById("tr-wrapper").hidden = true;
          document.getElementById("tr-text").hidden = true;
        }

        document.getElementById("top-right-icon").src = newic;

        updateTextTR();
      }

      function updateBottomLeftIcon() {
        let newic = "";
        let ic = document.getElementById("bottom-left").value;

        if (ic == "wp") { newic = "ability-creator-images/icons/Weapon Power_L.png"; }
        if (ic == "sp") { newic = "ability-creator-images/icons/Spell Power_L.png"; }
        if (ic == "hp") { newic = "ability-creator-images/icons/Health_L.png"; }
        if (ic == "phys") { newic = "ability-creator-images/icons/Physical Damage_L.png"; }
        if (ic == "arm") { newic = "ability-creator-images/icons/Armor_L.png"; }

        if (ic == "dice") { newic = "ability-creator-images/icons/Dice_L.png"; }
        if (ic == "flank") { newic = "ability-creator-images/icons/must flank the enemy.png"; }

        document.getElementById("bottom-left-icon").src = newic;
      }

      function updateBottomRightIcon() {
        let newic = "ability-creator-images/lower-right/";
        let tt = document.getElementById("target-type");
        let ic = document.getElementById("bottom-right").value;
        if (ic !== "none" && ic !== "crit") {
          if (ic == "st") { ic = "single target"; }
          newic = newic + ic + " " + tt.value + ".png";
          document.getElementById("target-type-cont").hidden = false;
        } else {
          if (ic == "crit") {
            newic = newic + "Critical_L.png";
          } else { newic = ""; }
          document.getElementById("target-type-cont").hidden = true;
        }

        document.getElementById("bottom-right-icon").src = newic;
      }

      function updateDesc() {
        desc = document.getElementById("desc").value;
        desc = desc.replaceAll(String.fromCharCode(10),"</span><br/><span>");
        desc = desc.replaceAll(" ", "</span><span> </span><span>");

        desc = "<span>" + desc;
        desc = desc.replaceAll("[", "</span>[");
        desc = desc.replaceAll("]", "]<span>");
        replaceDescIcon();
        for (let i = 0; i < key_tag.length; i++) {
          let nx = key_tag[i];
          desc = desc.replaceAll(nx[0], nx[1]);
        }
        desc = desc + "</span>";
        desc = desc.replaceAll("<span></span>","");

        document.getElementById("resultDesc").innerHTML = desc;
      }

      function replaceDescIcon() {
        desc = replaceDescIconInner(desc);
      }

      function replaceDescIconInner(s) {
        for (let i = 0; i < key_icon.length; i++) {
          let nx = key_icon[i];
          s = customReplace(s, nx[0], nx[1]);
        }

        return s;

        function customReplace(str, key, fp) {
          let cl = "icon";
          let add_data = "";
          if (key == "[talent]") { cl = "iconL"; }
          return str.replaceAll(key, "<img class='" + cl
              + "' src='ability-creator-images/icons/"
              + fp + "'></img>");
        }
      }

      let mainImgSize;

      function updateMainImage() {
        if (FileReader) {
          const prev = document.getElementById("main-image");
          const file = document.getElementById("img-src").files[0];
          var rd = new FileReader();

          rd.addEventListener("load", function() {
            prev.src = rd.result;

            let img = new Image();
            img.src = prev.src;
            img.addEventListener("load", function() {
              mainImgSize = { w: img.width, h: img.height };
              updateMainImageSize();
            });
          }, false);
          if (file) {
            rd.readAsDataURL(file);
          }
        } else { console.log("error, didn't load"); }

        abilityImageDragScroll();
      }

      function updateMainImageSize() {
        if (mainImgSize == null) { return; }
        let img_elem = document.getElementById("main-image");

        let sz = document.getElementById("zoom-input").value / 100;

        sz = Math.max(0.1, Math.min(5, sz));
        img_elem.style.width = Math.floor(mainImgSize.w * sz) + "px";
        img_elem.style.height = Math.floor(mainImgSize.h * sz) + "px";
      }

      /* Image Scrolling with Drag */
      function abilityImageDragScroll() {
        const wr = document.getElementById("main-image-wrapper");
        let mouseD = false;
        let startX, startY, scrollLeft, scrollTop;

        let startDrag = function(e) {
          let currEle = document.elementFromPoint(e.clientX, e.clientY);
          let correctEle1 = document.getElementById("main-image");
          let correctEle2 = document.getElementById("main-image-wrapper");
          if (currEle != correctEle1
              && currEle != correctEle2) { return; }
          mouseD = true;
          startX = e.pageX - wr.offsetLeft;
          startY = e.pageY - wr.offsetTop;
          scrollLeft = wr.scrollLeft;
          scrollTop = wr.scrollTop;
        };
        let stopDrag = function(e) { mouseD = false; };

        let moveDrag = function(e) {
          e.preventDefault();
          if(!mouseD) { return; }
          const x = e.pageX - wr.offsetLeft;
          const scrollX = x - startX;
          wr.scrollLeft = scrollLeft - scrollX;
          const y = e.pageY - wr.offsetTop;
          const scrollY = y - startY;
          wr.scrollTop = scrollTop - scrollY;
        };

        document.removeEventListener("mousemove", moveDrag, false);
        document.removeEventListener("mousedown", startDrag, false);
        document.removeEventListener("mouseup", stopDrag, false);

        document.addEventListener("mousemove", moveDrag, false);
        document.addEventListener("mousedown", startDrag, false);
        document.addEventListener("mouseup", stopDrag, false);
      }

      function toggleFrame() {
        if (document.getElementById("frame-toggle").checked) {
          document.getElementById("main-image-frame").hidden = false;
        } else { document.getElementById("main-image-frame").hidden = true; }
      }

      // Create hover when over an element
      let hovering; // src of img element being hovered over
      document.addEventListener('mousemove', e => {
        let oldele = hovering;
        let hoverElement = document.elementFromPoint(e.clientX, e.clientY);
        if (hoverElement !== null
            && hoverElement.id !== "main-image" // needed b/c excluding this caused fps issues
            && hoverElement.tagName == "IMG") {
          hovering = hoverElement.src;
          hovering = hovering.replaceAll("%20", " ");
          hoverAction(e);
        } else {
          hovering = "";
          hoverHide();
        }
        }, {passive: true});

      function getMatchingText() {
        let out = "";
        for (let i = 0; i < key_icon.length && out == ""; i++) {
          let nextKey = key_icon[i];
          if (hovering.indexOf(nextKey[1]) > -1) { out = nextKey[0]; }
        }
        return out;
      }

      function hoverAction(e) {
        let hov = document.getElementById("hovertext");
        if (hov == null) { return; } // idk why I got an error with the next line
        hov.innerHTML = getMatchingText();
        let hovDims = hov.getBoundingClientRect();
        let wd = hovDims.width;
        let mainDims = document.getElementById("creatorbox").getBoundingClientRect();
        let maxwd = mainDims.x + mainDims.width;
        hov.style.top = (e.clientY - 30) + "px";
        hov.style.left = (e.clientX + 10) + "px";

        if (wd + e.clientX + 10 >= maxwd) {
          hov.style.left = (maxwd - wd) + "px";
          // hovering on 1st frame can still get the text to align incorrectly
          // I still don't know why this happens
          // i give up trying to troubleshoot this any further
        }
        hov.hidden = false;
      }

      function hoverHide() {
        let hov = document.getElementById("hovertext");
        if (hov !== null) { hov.hidden = true; }
      }

      /* Draw Result to 1 Image ------------------------ */
      function drawResult() {
        document.getElementById("resultimagecont").innerHTML = "";
        let newC = document.createElement("canvas");
        newC.id = "drawresult";
        newC.width = 152;
        newC.height = 256;
        let newCtx = newC.getContext("2d");
        document.getElementById("resultimagecont").appendChild(newC);

        // get main location
        const baseLoc = document.getElementById("resultholder").getBoundingClientRect();

        // draw the bg
        let bg_img = new Image();
        bg_img.src = document.getElementById("bg").src;
        newCtx.drawImage(bg_img, 0, 0);

        // draw the main image
        drawMainImage();

        // draw power frame
        drawPowerFrame();

        // draw middle stuff
        drawTopRightIcon();

        // preset for non-desc text
        newCtx.font = "15px shermlock";
        newCtx.transform(1, 0, 0, 0.8, 0, 0);
        newCtx.textAlign = "center";
        newCtx.textBaseline = "middle"; // why are these keywords differentistg

        // Shermlock texts
        drawTitleText();
        drawMiddleText();

        // adjust transform to account for resultDesc's scaling on text
        newCtx.transform(1.25, 0, 0, 1.25, 0, 0);
        newCtx.font = "600 " + (12 * 0.8) + "px Comic Sans MS";

        drawDescription();
        clearSide();
        drawRankText();

        function drawMainImage() {
          let s = document.getElementById("main-image").src;
          let img = new Image();
          img.src = s;

          let wr = document.getElementById("main-image-wrapper");
          let x = wr.scrollLeft;
          let y = wr.scrollTop;
          let sc = document.getElementById("zoom-input").value / 100;

          newCtx.drawImage(img, x / sc, y / sc, 119 / sc, 119 / sc, 17, 45, 119, 119);
        }

        function drawPowerFrame() {
          let fr = document.getElementById("main-image-frame");
          if (fr.hidden) { return; }

          let img = new Image();
          img.src = fr.src;
          newCtx.drawImage(img, 16, 44, 121, 121);
        }

        function drawTitleText() {
          newCtx.fillStyle = "#FCEF01";

          const ttlEle = document.getElementById("resultTitle");
          let ttlFontSize = ttlEle.style.fontSize
              || window.getComputedStyle(ttlEle, null).getPropertyValue("font-size");
          newCtx.font = ttlFontSize + " shermlock";
          let ttlTxt = ttlEle.value;
          let ttlTxt_1 = "";
          let ttlTxt_2 = "";

          // line 1
          ttlTxt_1 = ttlTxt;
          let newLine = false;
          if (ttlTxt.indexOf(String.fromCharCode(10)) > -1) {
            let place = ttlTxt.indexOf(String.fromCharCode(10));
            ttlTxt_1 = ttlTxt.substring(0, place);
            ttlTxt = ttlTxt.substring(place + 1);
            newLine = true;
          } else { ttlTxt = ""; }
          newCtx.fillText(ttlTxt_1, 76, 28);

          // line 2
          ttlTxt_2 = ttlTxt;
          if (ttlTxt.indexOf(String.fromCharCode(10)) > -1) {
            let place = ttlTxt.indexOf(String.fromCharCode(10));
            ttlTxt_2 = ttlTxt.substring(0, place);
            ttlTxt = ttlTxt.substring(place + 1);
          }
          newCtx.fillText(ttlTxt_2, 76, 43);

          // no more lines are rendered
        }

        function drawDescription() {
/*
          newCtx.font = "600 " + (12 * 0.8) + "px Comic Sans MS";
*/
          newCtx.transform(1, 0, 0, 1.25, 0, 0);
              // 1 / 0.8 = 1.25, idk why it's like this

          newCtx.textAlign = "left";
          newCtx.textBaseline = "bottom";
          newCtx.fillStyle = "black";

          let descEleList = document.getElementById("resultDesc").childNodes;
          for (let i = 0; i < descEleList.length; i++) {
            let nextEle = descEleList[i];
            let pos = nextEle.getBoundingClientRect();
            let diffX = pos.x - baseLoc.x;
            let diffY = pos.y - baseLoc.y;
            if (nextEle.tagName == "SPAN" && nextEle.className == "") {
              let nextTxt = nextEle.innerHTML.replaceAll("<br>", "");
              newCtx.fillText(nextTxt, diffX,
                  diffY + pos.height * 1 + 0.5);
            }
            if (nextEle.tagName == "IMG") {
              let dims = nextEle.getBoundingClientRect();
              let img = new Image();
              img.src = nextEle.src;
              newCtx.drawImage(img, diffX, diffY, dims.width, img.height * dims.width / img.width);
            }
            if (nextEle.tagName == "SPAN" && nextEle.className !== "") {
              innerDraw(nextEle);
            }
          }

          function innerDraw(ele) {
            let initFS = newCtx.font;
            let fs = window.getComputedStyle(ele).getPropertyValue("font-size");
            newCtx.font = "600 " + (parseInt(fs) * 0.8) + "px Comic Sans MS";
            console.clear()
            let children = ele.childNodes;
            for (let i = 0; i < children.length; i++) {
              let nextEle = children[i];
              console.log(nextEle)
              let pos = nextEle.getBoundingClientRect();
              let diffX = pos.x - baseLoc.x;
              let diffY = pos.y - baseLoc.y;
              if (nextEle.tagName == "IMG") {
                let img = new Image();
                img.src = nextEle.src;
                newCtx.drawImage(img, diffX, diffY, pos.width,
                    img.height * pos.width / img.width);
              } else {
                let newTxt = nextEle.innerHTML.replaceAll("<br>", "");
                newCtx.fillText(newTxt, diffX,
                    diffY + pos.height + 0);
              }
            }
            newCtx.font = "600 " + (12 * 0.8) + "px Comic Sans MS";
          }
        }

        function drawTopRightIcon() {
          let icList = ["top-left-icon", "top-right-icon",
              "bottom-left-icon", "bottom-right-icon"];
          for (let i = 0; i < icList.length; i++) {
            let nextStr = icList[i];
            drawIcon(nextStr);
          }

          function drawIcon(str) {
            let tr = document.getElementById(str);
            let s = tr.src;
            if (s.indexOf("none") > -1) { return; }

            let pos = tr.getBoundingClientRect();
            let diffX = pos.x - baseLoc.x;
            let diffY = pos.y - baseLoc.y;
            let scale = 1.25;

            let tempImg = new Image();
            tempImg.src = s;
            newCtx.drawImage(tempImg, diffX * 1.25, diffY * 1.25, tempImg.width, tempImg.height);
          }
        }

        function drawMiddleText() {
          let idList = ["tl-text", "tr-text", "bl-text", "br-text"];
          let locList = [
            [38, 87], [114, 86], [38, 202], [115, 202]
          ];

          for (let i = 0; i < idList.length; i++) {
            drawAccompText(i);
          }

          function drawAccompText(num) {
            const txtEle = document.getElementById(idList[num]);
            if (txtEle.hidden == true) { return; }
            let txtFontSize = window.getComputedStyle(txtEle, null).getPropertyValue("font-size");
            newCtx.font = txtFontSize + " shermlock";
            let txtTxt = txtEle.innerHTML;

            // line 1
            let txtTxt_1 = txtTxt;
            let newLine = false;
            if (txtTxt.indexOf(String.fromCharCode(10)) > -1) {
              let place = txtTxt.indexOf(String.fromCharCode(10));
              txtTxt_1 = txtTxt.substring(0, place);
              txtTxt = txtTxt.substring(place + 1);
              newLine = true;
            }
            let nextpos = locList[num];

            newCtx.shadowColor = "black";
            newCtx.shadowBlur = 5;
            newCtx.lineWidth = 0;
            for (let i = 0; i < 8; i++) {
              newCtx.strokeText(txtTxt_1, nextpos[0], nextpos[1]);
            }

            newCtx.fillStyle = "white";
            newCtx.shadowBlur = 0;
            newCtx.fillText(txtTxt_1, nextpos[0], nextpos[1]);
          }
        }

        function drawRankText() {
          newCtx.textAlign = "center";
          newCtx.textBaseline = "top";

          let rnkEle = document.getElementById("rnk-text");
          if (rnkEle.hidden) { return; }

          let box = rnkEle.getBoundingClientRect();
          let diffX = box.x - baseLoc.x;
          let diffY = box.y - baseLoc.y;

          let rnkTxt = rnkEle.innerHTML;
          newCtx.fillText(rnkTxt, diffX + box.width * 0.5, diffY + 3);
        }

        function clearSide() {
          newCtx.transform(0.8, 0, 0, 0.8, 0, 0);
          let imgsrc = document.getElementById("bg").src;
          let lowY = 245;
          if (imgsrc.indexOf("talent") > -1) { lowY = 232; }

          let baseimg = new Image();
          baseimg.src = imgsrc;
          newCtx.drawImage(baseimg, 0, 0, 10, 256,
              0, 0, 10, 256); // left side
          newCtx.drawImage(baseimg, 142, 0, 10, 256,
              142, 0, 10, 256); // right side
          newCtx.drawImage(baseimg, 0, lowY, 152, 256,
              0, lowY, 152, 256); // bottom

          newCtx.transform(1.25, 0, 0, 1.25, 0, 0);
        }
      }

      function downloadResult() {
        drawResult();

        let canv = document.getElementById("drawresult");
        let img = new Image();
        img.src = canv.toDataURL("image/png");

        let ttl = document.getElementById("title").value;
        if (ttl == "") { ttl = "result-ability"; }

        let temp = document.createElement("a");
        temp.href = img.src;
        temp.download = ttl + ".png";

        document.body.appendChild(temp);
        temp.click();
        document.body.removeChild(temp);
        
        document.getElementById("resultimagecont").innerHTML = "";
      }
    </script>

    <div class="creatorbox" id="creatorbox">

      <div class="maincont">

      <div>
        <h1>Pirate101 Abilities Creator</h1>
        <p>
          Ever wanted to create a custom Pirate101 Power or Epic Talent?
          <br/>Now, you do that with ease! (mostly)
          <br/>Just fill in the blanks, and this page does the rest!

          <br/><br/>
          Note: does not auto-save for you if you revisit the page.
          <br/>(I advise saving notes in a text document in case you need to revisit an unfinished idea later on.)

          <br/><br/>
          This works best on a computer. I don't currently recommend using this with mobile devices since I haven't tested those yet.
          <br/>(main issue being font size inconsistency linked to what I assume is device / browser interpretation, which does affect the end result)

          <br/><br/>
          Credits go to KingsIsle Entertainment for Pirate101.
          <br/>Thanks for visiting / using this page!
        </p>
      </div>

      <table style="margin-left: auto; margin-right: auto">
      <tr>
      <td>

      <div class="input">
        <h3>Ability Information</h3>
        <table>
          <tr>
            <td>
              Ability Type
            </td>
            <td class="tdLeft">
              <select id="ability-type" class="ability-select" onchange="updateBG()">
                <option value="power">Power</option>
                <option value="talent">Talent / Epic Talent</option>
              </select>
              <span id="rnk-wrapper" hidden><br/>Rank:
                <input id="rnk" oninput="updateRank()" value="1 of 3"></input>
              </span>
            </td>
          </tr>
          <tr>
            <td>
              Image<br/><br/>&nbsp;
            </td>
            <td>
              <input id="img-src" type="file" accept="image/png, image/jpeg" onchange="updateMainImage()"></input>
              <br/>
              Image zoom:<input type="number" id="zoom-input" value="100" min="10" max="500" oninput="updateMainImageSize()" style="text-align: right"></input>%
              <br/>
              <input type="checkbox" class="checkboxbox" id="frame-toggle" onclick="toggleFrame()">
                <span class="even-smaller">Show Power frame + disable img scroll</span>
              </input>
            </td>
          </tr>
          <tr>
            <td>
              Title<br/>&nbsp;
            </td>
            <td class="tdLeft">
              <textarea id="title" oninput="updateTitle()"></textarea>
              <br/>
              <input type="checkbox" id="fonttoggle" onclick="changeTitleFontSize()">Use small text?</input>
            </td>
          </tr>
          <tr>
            <td>
              Upper-Left Icon
            </td>
            <td class="tdLeft">
              <select id="top-left" class="upper-left-select" onchange="updateTopLeftIcon()">
                <option value="none">none</option>
                <option value="fc">Fire Count</option>
                <option value="duration">Duration</option>
              </select>
              <span id="fc-wrapper" hidden>&nbsp;Amount:
                <input id="fc" oninput="updateTextTL()" value="1"></input>
              </span>
            </td>
          </tr>
          <tr>
            <td>
              Upper-Right Icon
            </td>
            <td class="tdLeft">
              <select id="top-right" class="upper-right-select" onchange="updateTopRightIcon()">
                <option value="none">none</option>
                <option value="haste">Movement</option>
                <option value="range">Range</option>
                <option value="melee">Melee Attack</option>
                <option value="ranged">Ranged Attack</option>
                <option value="magic">Magical Attack</option>
              </select>
              <span id="tr-wrapper" hidden>&nbsp;Amount:
                <input id="tr" oninput="updateTextTR()" value="x1"></input>
              </span>
            </td>
          </tr>
          <tr>
            <td>
              Lower-Left Icon
            </td>
            <td class="tdLeft">
              <select id="bottom-left" class="lower-left-select" onchange="updateBottomLeftIcon()">
                <option value="none">none</option>
                <option value="wp">Weapon Power</option>
                <option value="sp">Spell Power</option>
                <option value="hp">Health</option>
                <option value="phys">Physical Damage</option>
                <option value="arm">Armor</option>
                <option value="dice">Dice</option>
                <option value="flank">Flank</option>
              </select>
              Text:<input id="bl" oninput="updateTextBL()"></input>
            </td>
          </tr>
          <tr>
            <td>
              Lower-Right Icon
            </td>
            <td class="tdLeft">
              <select id="bottom-right" class="lower-right-select" onchange="updateBottomRightIcon()">
                <option value="none">none</option>
                <option value="st">single</option>
                <option value="3x3">3x3</option>
                <option value="plus">+ Pattern</option>
                <option value="cross">X Pattern</option>
                <option value="cone">cone</option>
                <option value="line">line</option>
                <option value="wall">wall</option>
                <option value="crit">Critical</option>
              </select>
              <span id="target-type-cont" hidden>
                Targeting:
                <select id="target-type" class="lower-right-select" onchange="updateBottomRightIcon()">
                  <option value="red">enemy</option>
                  <option value="orange">neutral</option>
                  <option value="green">ally</option>
                </select>
              </span>
              <br/>Lower-right text:<input id="br" oninput="updateTextBR()"></input>
            </td>
          </tr>
          <tr>
            <td>
              Description
            </td>
            <td>
              <textarea id="desc" oninput="updateDesc()"></textarea>
            </td>
          </tr>
        </table>
      </div>

      </td>
      <td>

      <button onclick="downloadResult()">Download</button>

      <div class="resultholder" id="resultholder">
        <img id="bg" src="ability-creator-images/power-template.png" />

        <div id="main-image-wrapper">
          <img id="main-image"></img>
        </div>
        <img id="main-image-frame" src="ability-creator-images/power-frame-2.png" hidden></img>

        <img id="top-left-icon"></img>
        <img id="top-right-icon"></img>
        <img id="bottom-left-icon"></img>
        <img id="bottom-right-icon"></img>

        <img id="inf" src="ability-creator-images/icons/Infinity.png" hidden></img>

        <div id="tl-text"></div>
        <div id="tr-text"></div>
        <div id="bl-text"></div>
        <div id="br-text"></div>

        <div id="rnk-text"></div>

        <textarea id="resultTitle" readonly></textarea>

        <div id="resultDescCont">
          <div id="resultDesc"></div>
        </div>
      </div>

      </td>
      <td>

      <div>
        <h3>Icon Guide (for description)</h3>
        Hover over icons to see their 'code' in the Description box.
        <br/>&nbsp;
        <table style="width: 225px">
          <tr>
            <td>
              Stats
            </td>
            <td>
              <img class="icon" src="ability-creator-images/icons/Health_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/Weapon Power_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/Spell Power_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/Strength_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/Agility_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/Will_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/Accuracy_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/Dodge_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/Movement_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/Range_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/Critical_L.png"></img>
            </td>
          </tr>
          <tr>
            <td>
              Damage
            </td>
            <td>
              <img class="icon" src="ability-creator-images/icons/Physical Damage_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/Magical Damage.png"></img>
              <img class="icon" src="ability-creator-images/icons/Armor_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/Resist_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/Armor Piercing_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/Poison.png"></img>
              <img class="icon" src="ability-creator-images/icons/Bleeding.png"></img>
            </td>
          </tr>
          <tr>
            <td>
              Effects
            </td>
            <td>
              <img class="icon" src="ability-creator-images/icons/Buff_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/Debuff_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/Duration.png"></img>
              <img class="icon" src="ability-creator-images/icons/Dice_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/Talent Rank.png"></img>
              <img class="icon" src="ability-creator-images/icons/Threat Generation_L.png"></img>
            </td>
          </tr>
          <tr>
            <td>
              Weapon Types
            </td>
            <td>
              <img class="icon" src="ability-creator-images/icons/Melee_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/Smashy Weapon.png"></img>
              <img class="icon" src="ability-creator-images/icons/Stabby Weapon.png"></img>
              <img class="icon" src="ability-creator-images/icons/Shooty Weapon.png"></img>
              <img class="icon" src="ability-creator-images/icons/Staffy Weapon.png"></img>
            </td>
          </tr>
          <tr>
            <td>
              Trainable Traps
            </td>
            <td>
              <img class="icon" src="ability-creator-images/icons/Claw Trap.png"></img>
              <img class="icon" src="ability-creator-images/icons/Bear Trap.png"></img>
              <img class="icon" src="ability-creator-images/icons/Scatter Spike Trap.png"></img>
              <img class="icon" src="ability-creator-images/icons/Musketeers Trap.png"></img>
              <img class="icon" src="ability-creator-images/icons/Bonfire Trap.png"></img>
            </td>
          </tr>
          <tr>
            <td>
              Other Traps
            </td>
            <td>
              <img class="icon" src="ability-creator-images/icons/Blood Flames.png"></img>
              <img class="icon" src="ability-creator-images/icons/Singular Spike Trap.png"></img>
              <img class="icon" src="ability-creator-images/icons/Starfish.png"></img>
              <img class="icon" src="ability-creator-images/icons/Storm Cloud.png"></img>
            </td>
          </tr>
          <tr>
            <td>
              Obstacles
            </td>
            <td>
              <img class="icon" src="ability-creator-images/icons/Barricade.png"></img>
              <img class="icon" src="ability-creator-images/icons/Powder Keg.png"></img>
              <img class="icon" src="ability-creator-images/icons/Ice Obstacle.png"></img>
              <img class="icon" src="ability-creator-images/icons/Stone Obstacle_L.png"></img>
            </td>
          </tr>
          <tr>
            <td>
              Summons
            </td>
            <td>
              <img class="icon" src="ability-creator-images/icons/Skeletal Pirate.png"></img>
              <img class="icon" src="ability-creator-images/icons/Skeletal Corsair.png"></img>
              <img class="icon" src="ability-creator-images/icons/Bone Drake.png"></img>
              <img class="icon" src="ability-creator-images/icons/Skeleton Hoplite.png"></img>
              <img class="icon" src="ability-creator-images/icons/Skeletal Warrior.png"></img>
              <img class="icon" src="ability-creator-images/icons/Golem.png"></img>
              <img class="icon" src="ability-creator-images/icons/Crab Crawlie.png"></img>
              <img class="icon" src="ability-creator-images/icons/Scorpion.png"></img>
              <img class="icon" src="ability-creator-images/icons/Lagooney.png"></img>
              <img class="icon" src="ability-creator-images/icons/Cherry Blossom Treant.png"></img>
              <img class="icon" src="ability-creator-images/icons/Blue Oni.png"></img>
              <img class="icon" src="ability-creator-images/icons/Terracotta Warrior.png"></img>
              <img class="icon" src="ability-creator-images/icons/Terror-cotta Warrior.png"></img>
            </td>
          </tr>
          <tr>
            <td>
              Other Pirate101 Icons
            </td>
            <td>
              <img class="icon" src="ability-creator-images/icons/AoE.png"></img>
              <img class="icon" src="ability-creator-images/icons/Movement specify.png"></img>
              <img class="icon" src="ability-creator-images/icons/Range specify.png"></img>
              <img class="icon" src="ability-creator-images/icons/Bonus Effects on Enemy Territory.png"></img>
              <img class="icon" src="ability-creator-images/icons/must flank the enemy.png"></img>
            </td>
          </tr>
          <tr>
            <td>
              Wizard101 Icons
            </td>
            <td>
              <img class="icon" src="ability-creator-images/icons/W101 Drain_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/W101 Stun_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/W101 Incoming_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/W101 Outgoing_L.png"></img>
              <img class="icon" src="ability-creator-images/icons/W101 Afterlife_L.png"></img>
            </td>
          </tr>
        </table>
      </div>

      </td>
      </tr>
      </table>

      <div id="resultimagecont">
      </div>

      </div>
    </div>

    <div id="hovertext"></div>
  </body>
</html>